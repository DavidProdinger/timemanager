version: "3.4"

x-restart-policy: &restart_policy
  restart: unless-stopped
x-logging-config: &logging_config
  logging:
    driver: "json-file"
    options:
      max-file: "10"
      max-size: "50m"

volumes:
  nextcloud:
  db:

services:
  web:
    <<: *restart_policy
    <<: *logging_config
    image: nginx:alpine
    ports:
      - 8000:80
    links:
      - app
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - nextcloud:/var/www/html:ro
      - ../:/var/www/html/custom_apps/timemanager:ro
    environment:
      - VIRTUAL_PORT=80
      - VIRTUAL_HOST=nextcloud.localhost

  redis:
    <<: *restart_policy
    <<: *logging_config
    image: redis:alpine
    hostname: nextcloud-redis
    command: redis-server --requirepass df9dbf12f78f9bb9e9902ac99c3f32a834df91a7e1d07baeb2ca84ee4e4cb620
    ports:
      - "6379:6379"

  db:
    <<: *restart_policy
    <<: *logging_config
    image: mariadb:10.5
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    ports:
      - 3306:3306
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_PASSWORD=7fd7504c5d556c09bedfda10785574e2285952ba0c1796373d51aa8b278210c1
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud

  app:
    <<: *restart_policy
    <<: *logging_config
    image: nextcloud:stable-fpm-alpine
    ports:
      - 9000:9000
    links:
      - db
      - redis
    volumes:
      - nextcloud:/var/www/html
      - ../:/var/www/html/custom_apps/timemanager
    environment:
      - REDIS_HOST=redis
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=7fd7504c5d556c09bedfda10785574e2285952ba0c1796373d51aa8b278210c1
      - MYSQL_HOST=db
      - REDIS_HOST_PASSWORD=df9dbf12f78f9bb9e9902ac99c3f32a834df91a7e1d07baeb2ca84ee4e4cb620
